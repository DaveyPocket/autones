#include <avr/interrupt.h>
#include <avr/pgmspace.h>
#include <avr/io.h>

uint8_t button_number;
// we are using naive run-length encoding
// frames[0] corresponds to how many frames we should be pressing buttons[0]
PROGMEM const uint16_t frames[] = {4,1,1,1,42,1,626,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,1,22,18,30,147,25,31,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,26,16,3,1,3,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,1,33,2,8,2,3,5,9,25,6,1,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,13,4,19,1,3,1,3,1,3,1,3,1,2,1,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,2,1,1,3,1,3,1,1,15,7,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,1,1,2,36,1,4,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,19,4,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,20,9,1,25,4,1,17,7,1,10,5,3,43,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,1,5,1,4,2,3,2,32,1,3,1,3,1,3,1,3,1,3,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,23,49,2,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,21,1,1,1,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,24,1,33,1,3,1,6,8,2,43,85,1,31,1,3,1,3,1,3,1,7,1,3,1,3,1,3,1,67,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,2,7,2,15,17,1,3,1,3,1,3,1,2,4,1,5,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,9,3,1,3,1,3,1,3,1,3,1,2,1,1,3,1,4,1,21,2,3,1,2,1,41,1,3,1,3,1,3,1,14,3,7,9,9,15,31,46,233,2,13,5,8,4,7,4,7,4,7,5,7,4,8,4,7,5,9,4,8,3,8,4,8,5,8,4,9,4,10,4,9,4,8,4,8,5,8,5,8,4,8,4,8,3,1,1,8,3,8,4,9,5,8,4,13,4,12,2,10,3,10,5,8,5,7,5,8,5,8,5,7,4,6,6,14,4,10,4,9,5,7,5,8,5,10,4,0};

PROGMEM const uint8_t buttons[] = {0,4,0,8,0,8,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,2,0,146,162,146,2,162,2,130,128,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,0,128,146,130,146,82,146,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,0,64,128,64,0,162,2,146,162,130,146,2,66,2,130,2,130,2,66,2,130,2,66,2,130,2,66,2,130,2,66,2,130,2,66,2,130,2,66,2,130,2,66,2,130,2,66,2,130,2,66,2,128,130,128,130,128,130,128,162,128,130,128,130,128,144,130,128,130,128,130,128,130,128,130,128,130,128,130,128,130,128,130,128,130,128,130,128,130,128,160,130,128,130,128,130,128,2,66,130,66,2,130,66,2,130,66,0,128,64,0,128,64,0,128,64,0,128,64,0,128,64,0,128,64,0,128,64,0,128,146,2,0,2,0,162,0,2,0,2,0,162,0,162,0,2,0,2,0,2,0,146,0,2,0,2,0,2,0,146,0,2,0,2,0,2,0,2,66,2,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,130,2,162,2,146,2,146,147,146,2,130,128,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,130,2,146,128,0,128,0,128,64,128,64,128,64,128,64,128,64,128,64,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,64,0,128,0,128,130,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,0,64,0,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,162,2,162,2,146,2,146,130,2,130,66,130,66,130,66,130,66,130,66,130,64,128,64,128,64,128,64,128,64,128,64,128,66,130,66,130,66,130,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,64,128,130,2,130,128,64,128,64,128,64,128,64,128,130,146,130,67,66,130,66,130,66,130,66,128,64,128,64,128,64,128,64,128,64,128,64,128,64,130,66,130,66,130,66,130,66,130,66,130,66,130,66,128,64,66,130,128,2,130,66,130,128,64,128,64,66,162,66,130,66,130,66,130,66,162,130,162,130,128,64,65,64,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0};
uint16_t movie_size = sizeof(buttons);
uint16_t index = 0;

uint16_t frame = frames[0];
uint8_t button = ~(buttons[0]);

int main(void) {
  // fire interrupt 0 on a rising edge (of pin 2, latch)
  EICRA = (1<<ISC01) | (1<<ISC00)
  // fire interrupt 1 on a rising edge (of pin 3, clock)
  EICRA = (1<<ISC11) | (1<<ISC10)
  // enable interrupt 1 and interrupt 0
  EIMSK = (1<<INT1) | (1<<INT0);
  // global interrupt enable
  sei();

  while(1){ };
  return 1;
}

// latch
ISR(INT0_vect) {
  if(frame == 0 && index < movie_size - 1){
    index++;
    frame = pgm_read_word_near(frames + index);
    button = ~(pgm_read_byte_near(buttons + index));
  }
  PORTB = button;
  buttons >>= 1;
  frame--;
}

// clock
ISR(INT1_vect) {
  _delay_ms(1);
  PORTB = button;
  buttons >>= 1;
}
